<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solna – Avgångar</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: system-ui, sans-serif;
      color: #000;
    }
    body { margin: 24px; }
    h1 { margin: 0 0 16px; font-size: 32px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 24px;
      background: transparent;
    }
    th, td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.2);
      text-align: left;
    }
    th { font-weight: 600; }

    .muted { opacity: 0.7; font-size: 14px; margin-top: 12px; }
    .error { color: #b00; font-size: 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1 id="title">Solna – Avgångar Tunnelbanan</h1>

  <table>
    <thead>
      <tr>
        <th>Tid</th>
        <th>Linje</th>
        <th>Till</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="3">Uppdaterar…</td></tr>
    </tbody>
  </table>

  <div class="muted" id="updated"></div>
  <div class="muted">data from Trafiklab.se</div>
  <div class="error" id="err"></div>

  <script>
    const API_KEY = "3dd8286df2134773827fafe73cefa7cf";      // <-- put your key here (ideally rotate it)
    const AREA_ID = "740098534";
    const REFRESH_MS = 30000;
    const ONLY_LINE = "11";          // <-- only show this line

    function pickTime(obj) {
      const t = obj.realtime || obj.rt || obj.time || obj.departure_time || obj.scheduled || obj.st || "";
      if (typeof t === "string" && t.includes("T")) return t.slice(11, 16);
      return typeof t === "string" ? t : "";
    }

    function pickLine(obj) {
      // Common fields across variants of this API
      return obj.line || obj.route?.designation || obj.route_id || obj.transport?.line || "";
    }

    function pickDestination(obj) {
      return obj.destination || obj.route?.direction || obj.direction || obj.to || obj.destination?.name || "";
    }

    async function load() {
      const errEl = document.getElementById("err");
      errEl.textContent = "";

      const url = `https://realtime-api.trafiklab.se/v1/departures/${AREA_ID}?key=${encodeURIComponent(API_KEY)}`;

      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        const list =
          data?.departures ||
          data?.stop_times ||
          data?.stopTimes ||
          data?.data ||
          [];

        const tbody = document.getElementById("rows");
        tbody.innerHTML = "";

        // Filter: ONLY show line 11
        const filtered = Array.isArray(list)
          ? list.filter(d => String(pickLine(d)).trim() === ONLY_LINE)
          : [];

        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3">Inga avgångar för linje ${ONLY_LINE}</td></tr>`;
        } else {
          for (const d of filtered.slice(0, 4)) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${pickTime(d)}</td>
              <td>${pickLine(d)}</td>
              <td>${pickDestination(d)}</td>
            `;
            tbody.appendChild(tr);
          }
        }

        const now = new Date();
        document.getElementById("updated").textContent =
          `Uppdaterad: ${now.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" })}`;

      } catch (e) {
        errEl.textContent = `Fel vid uppdatering: ${e.message}`;
      }
    }

    load();
    setInterval(load, REFRESH_MS);
  </script>
</body>
</html>
